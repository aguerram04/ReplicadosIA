"use strict";var t,e,s,r;function o(){}function n(){n.init.call(this)}function i(t){return void 0===t._maxListeners?n.defaultMaxListeners:t._maxListeners}function a(t,e,s){if(e)t.call(s);else for(var r=t.length,o=f(t,r),n=0;n<r;++n)o[n].call(s)}function c(t,e,s,r){if(e)t.call(s,r);else for(var o=t.length,n=f(t,o),i=0;i<o;++i)n[i].call(s,r)}function u(t,e,s,r,o){if(e)t.call(s,r,o);else for(var n=t.length,i=f(t,n),a=0;a<n;++a)i[a].call(s,r,o)}function d(t,e,s,r,o,n){if(e)t.call(s,r,o,n);else for(var i=t.length,a=f(t,i),c=0;c<i;++c)a[c].call(s,r,o,n)}function h(t,e,s,r){if(e)t.apply(s,r);else for(var o=t.length,n=f(t,o),i=0;i<o;++i)n[i].apply(s,r)}function p(t,e,s,r){var n,a,c,u;if("function"!=typeof s)throw new TypeError('"listener" argument must be a function');if((a=t._events)?(a.newListener&&(t.emit("newListener",e,s.listener?s.listener:s),a=t._events),c=a[e]):(a=t._events=new o,t._eventsCount=0),c){if("function"==typeof c?c=a[e]=r?[s,c]:[c,s]:r?c.unshift(s):c.push(s),!c.warned&&(n=i(t))&&n>0&&c.length>n){c.warned=!0;var d=new Error("Possible EventEmitter memory leak detected. "+c.length+" "+e+" listeners added. Use emitter.setMaxListeners() to increase limit");d.name="MaxListenersExceededWarning",d.emitter=t,d.type=e,d.count=c.length,u=d,"function"==typeof console.warn?console.warn(u):console.log(u)}}else c=a[e]=s,++t._eventsCount;return t}function l(t,e,s){var r=!1;function o(){t.removeListener(e,o),r||(r=!0,s.apply(t,arguments))}return o.listener=s,o}function m(t){var e=this._events;if(e){var s=e[t];if("function"==typeof s)return 1;if(s)return s.length}return 0}function f(t,e){for(var s=new Array(e);e--;)s[e]=t[e];return s}Object.defineProperty(exports,"__esModule",{value:!0}),o.prototype=Object.create(null),n.EventEmitter=n,n.usingDomains=!1,n.prototype.domain=void 0,n.prototype._events=void 0,n.prototype._maxListeners=void 0,n.defaultMaxListeners=10,n.init=function(){this.domain=null,n.usingDomains&&undefined.active,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new o,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},n.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||isNaN(t))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=t,this},n.prototype.getMaxListeners=function(){return i(this)},n.prototype.emit=function(t){var e,s,r,o,n,i,p,l="error"===t;if(i=this._events)l=l&&null==i.error;else if(!l)return!1;if(p=this.domain,l){if(e=arguments[1],!p){if(e instanceof Error)throw e;var m=new Error('Uncaught, unspecified "error" event. ('+e+")");throw m.context=e,m}return e||(e=new Error('Uncaught, unspecified "error" event')),e.domainEmitter=this,e.domain=p,e.domainThrown=!1,p.emit("error",e),!1}if(!(s=i[t]))return!1;var f="function"==typeof s;switch(r=arguments.length){case 1:a(s,f,this);break;case 2:c(s,f,this,arguments[1]);break;case 3:u(s,f,this,arguments[1],arguments[2]);break;case 4:d(s,f,this,arguments[1],arguments[2],arguments[3]);break;default:for(o=new Array(r-1),n=1;n<r;n++)o[n-1]=arguments[n];h(s,f,this,o)}return!0},n.prototype.addListener=function(t,e){return p(this,t,e,!1)},n.prototype.on=n.prototype.addListener,n.prototype.prependListener=function(t,e){return p(this,t,e,!0)},n.prototype.once=function(t,e){if("function"!=typeof e)throw new TypeError('"listener" argument must be a function');return this.on(t,l(this,t,e)),this},n.prototype.prependOnceListener=function(t,e){if("function"!=typeof e)throw new TypeError('"listener" argument must be a function');return this.prependListener(t,l(this,t,e)),this},n.prototype.removeListener=function(t,e){var s,r,n,i,a;if("function"!=typeof e)throw new TypeError('"listener" argument must be a function');if(!(r=this._events))return this;if(!(s=r[t]))return this;if(s===e||s.listener&&s.listener===e)0==--this._eventsCount?this._events=new o:(delete r[t],r.removeListener&&this.emit("removeListener",t,s.listener||e));else if("function"!=typeof s){for(n=-1,i=s.length;i-- >0;)if(s[i]===e||s[i].listener&&s[i].listener===e){a=s[i].listener,n=i;break}if(n<0)return this;if(1===s.length){if(s[0]=void 0,0==--this._eventsCount)return this._events=new o,this;delete r[t]}else!function(t,e){for(var s=e,r=s+1,o=t.length;r<o;s+=1,r+=1)t[s]=t[r];t.pop()}(s,n);r.removeListener&&this.emit("removeListener",t,a||e)}return this},n.prototype.off=function(t,e){return this.removeListener(t,e)},n.prototype.removeAllListeners=function(t){var e,s;if(!(s=this._events))return this;if(!s.removeListener)return 0===arguments.length?(this._events=new o,this._eventsCount=0):s[t]&&(0==--this._eventsCount?this._events=new o:delete s[t]),this;if(0===arguments.length){for(var r,n=Object.keys(s),i=0;i<n.length;++i)"removeListener"!==(r=n[i])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=new o,this._eventsCount=0,this}if("function"==typeof(e=s[t]))this.removeListener(t,e);else if(e)do{this.removeListener(t,e[e.length-1])}while(e[0]);return this},n.prototype.listeners=function(t){var e,s=this._events;return s&&(e=s[t])?"function"==typeof e?[e.listener||e]:function(t){for(var e=new Array(t.length),s=0;s<e.length;++s)e[s]=t[s].listener||t[s];return e}(e):[]},n.listenerCount=function(t,e){return"function"==typeof t.listenerCount?t.listenerCount(e):m.call(t,e)},n.prototype.listenerCount=m,n.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};class g extends n{}exports.EventType=void 0,(t=exports.EventType||(exports.EventType={})).Issue="issue",t.NetworkScoresUpdated="network-scores-updated",t.StatsParsingFinished="stats-parsing-finished",exports.IssueType=void 0,(e=exports.IssueType||(exports.IssueType={})).Network="network",e.CPU="cpu",e.Server="server",e.Stream="stream",exports.IssueReason=void 0,(s=exports.IssueReason||(exports.IssueReason={})).OutboundNetworkQuality="outbound-network-quality",s.InboundNetworkQuality="inbound-network-quality",s.OutboundNetworkMediaLatency="outbound-network-media-latency",s.InboundNetworkMediaLatency="inbound-network-media-latency",s.NetworkMediaSyncFailure="network-media-sync-failure",s.OutboundNetworkThroughput="outbound-network-throughput",s.InboundNetworkThroughput="inbound-network-throughput",s.EncoderCPUThrottling="encoder-cpu-throttling",s.DecoderCPUThrottling="decoder-cpu-throttling",s.ServerIssue="server-issue",s.UnknownVideoDecoderIssue="unknown-video-decoder",s.LowInboundMOS="low-inbound-mean-opinion-score",s.LowOutboundMOS="low-outbound-mean-opinion-score",s.FrozenVideoTrack="frozen-video-track",s.MissingVideoStreamData="missing-video-stream-data",s.MissingAudioStreamData="missing-audio-stream-data",exports.MosQuality=void 0,(r=exports.MosQuality||(exports.MosQuality={}))[r.BAD=2.1]="BAD",r[r.POOR=2.6]="POOR",r[r.FAIR=3.1]="FAIR",r[r.GOOD=3.8]="GOOD",r[r.EXCELLENT=4.3]="EXCELLENT";class S extends n{static STATS_REPORT_READY_EVENT="stats-report-ready";static STATS_REPORTS_PARSED="stats-reports-parsed";isStopped=!1;reportTimer;getStatsInterval;compositeStatsParser;constructor(t){super(),this.compositeStatsParser=t.compositeStatsParser,this.getStatsInterval=t.getStatsInterval??1e4}get isRunning(){return!!this.reportTimer&&!this.isStopped}startReporting(){if(this.reportTimer)return;const t=()=>setTimeout((()=>{this.isStopped?this.reportTimer=void 0:this.parseReports().finally((()=>{this.reportTimer=t()}))}),this.getStatsInterval);this.isStopped=!1,this.reportTimer=t()}stopReporting(){this.isStopped=!0,this.reportTimer&&(clearTimeout(this.reportTimer),this.reportTimer=void 0)}async parseReports(){const t=Date.now(),e=await this.compositeStatsParser.parse(),s=Date.now()-t;this.emit(S.STATS_REPORTS_PARSED,{timeTaken:s,reportItems:e}),e.forEach((t=>{this.emit(S.STATS_REPORT_READY_EVENT,t)}))}}const v=(()=>{const t=new Map;return e=>{const{taskId:s,delayMs:r,maxJitterMs:o,callback:n}=e,i=Math.ceil(Math.random()*(o||0)),a=t.get(s);a&&clearTimeout(a);const c=setTimeout((()=>{n(),t.delete(s)}),r+i);t.set(s,c)}})();class k{#t={};calculate(t){const{connection:{id:e}}=t,{mos:s,stats:r}=this.calculateOutboundScore(t)||{},{mos:o,stats:n}=this.calculateInboundScore(t)||{};return this.#t[e]=t,v({taskId:e,delayMs:35e3,callback:()=>delete this.#t[e]}),{outbound:s,inbound:o,connectionId:e,statsSamples:{inboundStatsSample:n,outboundStatsSample:r}}}calculateOutboundScore(t){const e=[...t.remote?.audio.inbound||[],...t.remote?.video.inbound||[]];if(!e.length)return;const s=this.#t[t.connection.id];if(!s)return;const r=[...s.remote?.audio.inbound||[],...s.remote?.video.inbound||[]],{packetsSent:o}=t.connection,n=s.connection.packetsSent,i=e.reduce(((t,e)=>{const s=r.find((t=>t.ssrc===e.ssrc));return{sumJitter:t.sumJitter+e.jitter,packetsLost:t.packetsLost+e.packetsLost,lastPacketsLost:t.lastPacketsLost+(s?.packetsLost||0)}}),{sumJitter:0,packetsLost:0,lastPacketsLost:0}),a=1e3*t.connection.currentRoundTripTime||0,{sumJitter:c}=i,u=c/e.length,d=o-n,h=i.packetsLost-i.lastPacketsLost,p=d&&h?Math.round(100*h/(d+h)):0;return{mos:this.calculateMOS({avgJitter:u,rtt:a,packetsLoss:p}),stats:{avgJitter:u,rtt:a,packetsLoss:p}}}calculateInboundScore(t){const e=[...t.audio?.inbound,...t.video?.inbound];if(!e.length)return;const s=this.#t[t.connection.id];if(!s)return;const r=[...s.video?.inbound,...s.audio?.inbound],{packetsReceived:o}=t.connection,n=s.connection.packetsReceived,i=e.reduce(((t,e)=>{const s=r.find((t=>t.ssrc===e.ssrc));return{sumJitter:t.sumJitter+e.jitter,packetsLost:t.packetsLost+e.packetsLost,lastPacketsLost:t.lastPacketsLost+(s?.packetsLost||0)}}),{sumJitter:0,packetsLost:0,lastPacketsLost:0}),a=1e3*t.connection.currentRoundTripTime||0,{sumJitter:c}=i,u=c/e.length,d=o-n,h=i.packetsLost-i.lastPacketsLost,p=d&&h?Math.round(100*h/(d+h)):0;return{mos:this.calculateMOS({avgJitter:u,rtt:a,packetsLoss:p}),stats:{avgJitter:u,rtt:a,packetsLoss:p}}}calculateMOS({avgJitter:t,rtt:e,packetsLoss:s}){const r=e+2*t+10;let o=r<160?93.2-r/40:93.2-r/120-10;return o-=2.5*s,1+.035*o+7e-6*o*(o-60)*(100-o)}}class y{#e=new Map;#s;#r;constructor(t={}){this.#s=t.statsCleanupTtlMs??35e3,this.#r=t.maxParsedStatsStorageSize??5}detect(t,e){const s={...t,networkScores:{...e,statsSamples:e?.statsSamples||{}}},r=this.performDetection(s);return this.setLastProcessedStats(t.connection.id,s),this.performPrevStatsCleanup({connectionId:t.connection.id}),r}performPrevStatsCleanup(t){const{connectionId:e,cleanupCallback:s}=t;this.#e.has(e)&&v({taskId:e,delayMs:this.#s,callback:()=>{this.deleteLastProcessedStats(e),"function"==typeof s&&s()}})}setLastProcessedStats(t,e){if(!t||e.connection.id!==t)return;const s=this.#e.get(t)??[];s.push(e),s.length>this.#r&&s.shift(),this.#e.set(t,s)}getLastProcessedStats(t){const e=this.#e.get(t);return e?.[e.length-1]}getAllLastProcessedStats(t){return this.#e.get(t)??[]}deleteLastProcessedStats(t){this.#e.delete(t)}}class w extends y{#o;constructor(t={}){super(t),this.#o=t.availableOutgoingBitrateThreshold??1e5}performDetection(t){const e=[],{availableOutgoingBitrate:s}=t.connection;if(void 0===s)return e;const r=t.audio.outbound.reduce(((t,e)=>t+e.targetBitrate),0),o=t.video.outbound.reduce(((t,e)=>t+e.bitrate),0);if(!r&&!o)return e;const n={availableOutgoingBitrate:s,videoStreamsTotalBitrate:o,audioStreamsTotalTargetBitrate:r};return r>s||o>0&&s<this.#o?(e.push({statsSample:n,type:exports.IssueType.Network,reason:exports.IssueReason.OutboundNetworkThroughput}),e):e}}class T extends y{#n;#i;#a;#c;constructor(t={}){super(),this.#n=t.highPacketLossThresholdPct??5,this.#i=t.highJitterThreshold??200,this.#a=t.highJitterBufferDelayThresholdMs??500,this.#c=t.highRttThresholdMs??250}performDetection(t){return this.processData(t)}processData(t){const e=[],s=[...t.audio?.inbound,...t.video?.inbound];if(!s.length)return e;const r=this.getLastProcessedStats(t.connection.id);if(!r)return e;const o=[...r.video?.inbound,...r.audio?.inbound],{packetsReceived:n}=t.connection,i=r.connection.packetsReceived,a=s.reduce(((t,e)=>{const s=o.find((t=>t.ssrc===e.ssrc)),r=s?.jitterBufferDelay||0,n=s?.jitterBufferEmittedCount||0,i=e.jitterBufferDelay-r,a=e.jitterBufferEmittedCount-n,c=i&&a?1e3*i/a:0;return{sumJitter:t.sumJitter+e.jitter,sumJitterBufferDelayMs:t.sumJitterBufferDelayMs+c,packetsLost:t.packetsLost+e.packetsLost,lastPacketsLost:t.lastPacketsLost+(s?.packetsLost||0)}}),{sumJitter:0,sumJitterBufferDelayMs:0,packetsLost:0,lastPacketsLost:0}),c=1e3*t.connection.currentRoundTripTime||0,{sumJitter:u,sumJitterBufferDelayMs:d}=a,h=u/s.length,p=d/s.length,l=n-i,m=a.packetsLost-a.lastPacketsLost,f=l&&m?Math.round(100*m/(l+m)):0,g=f>this.#n,S=h>=this.#i,v=c>=this.#c,k=p>this.#a,y=v&&!S&&!g,w=g&&S,T=S&&k,b={rtt:c,packetLossPct:f,avgJitter:h,avgJitterBufferDelay:p};return(S||g)&&e.push({statsSample:b,type:exports.IssueType.Network,reason:exports.IssueReason.InboundNetworkQuality,iceCandidate:t.connection.local.id}),y&&e.push({statsSample:b,type:exports.IssueType.Server,reason:exports.IssueReason.ServerIssue,iceCandidate:t.connection.remote.id}),w&&e.push({statsSample:b,type:exports.IssueType.Network,reason:exports.IssueReason.InboundNetworkMediaLatency,iceCandidate:t.connection.local.id}),T&&e.push({statsSample:b,type:exports.IssueType.Network,reason:exports.IssueReason.NetworkMediaSyncFailure,iceCandidate:t.connection.local.id}),e}}class b extends y{#u;constructor(t={}){super(),this.#u=t.correctedSamplesThresholdPct??5}performDetection(t){return this.processData(t)}processData(t){const e=t.audio.inbound,s=[],r=this.getLastProcessedStats(t.connection.id)?.audio.inbound;return r?(e.forEach((t=>{const e=r.find((e=>e.ssrc===t.ssrc));if(!e)return;const o=t.track.insertedSamplesForDeceleration+t.track.removedSamplesForAcceleration,n=e.track.insertedSamplesForDeceleration+e.track.removedSamplesForAcceleration;if(o===n)return;const i=t.track.totalSamplesReceived-e.track.totalSamplesReceived,a=o-n,c=Math.round(100*a/i),u={correctedSamplesPct:c};c>this.#u&&s.push({statsSample:u,type:exports.IssueType.Network,reason:exports.IssueReason.NetworkMediaSyncFailure,ssrc:t.ssrc})})),s):s}}class P extends y{#n;#i;constructor(t={}){super(),this.#n=t.highPacketLossThresholdPct??5,this.#i=t.highJitterThreshold??200}performDetection(t){return this.processData(t)}processData(t){const e=[],s=[...t.remote?.audio.inbound||[],...t.remote?.video.inbound||[]];if(!s.length)return e;const r=this.getLastProcessedStats(t.connection.id);if(!r)return e;const o=[...r.remote?.audio.inbound||[],...r.remote?.video.inbound||[]],{packetsSent:n}=t.connection,i=r.connection.packetsSent,a=s.reduce(((t,e)=>{const s=o.find((t=>t.ssrc===e.ssrc));return{sumJitter:t.sumJitter+e.jitter,packetsLost:t.packetsLost+e.packetsLost,lastPacketsLost:t.lastPacketsLost+(s?.packetsLost||0)}}),{sumJitter:0,packetsLost:0,lastPacketsLost:0}),c=1e3*t.connection.currentRoundTripTime||0,{sumJitter:u}=a,d=u/s.length,h=n-i,p=a.packetsLost-a.lastPacketsLost,l=h&&p?Math.round(100*p/(h+p)):0,m=l>this.#n,f=d>=this.#i,g=!m&&f||f||m,S={rtt:c,avgJitter:d,packetLossPct:l};return m&&f&&e.push({statsSample:S,type:exports.IssueType.Network,reason:exports.IssueReason.OutboundNetworkMediaLatency,iceCandidate:t.connection.local.id}),g&&e.push({statsSample:S,type:exports.IssueType.Network,reason:exports.IssueReason.OutboundNetworkQuality,iceCandidate:t.connection.local.id}),e}}class I extends y{performDetection(t){return this.processData(t)}processData(t){const e=t.video.outbound.filter((t=>"none"!==t.qualityLimitationReason)),s=[],r=this.getLastProcessedStats(t.connection.id)?.video.outbound;return r?(e.forEach((t=>{const e=r.find((e=>e.ssrc===t.ssrc));if(!e)return;const o={qualityLimitationReason:t.qualityLimitationReason};t.framesSent>e.framesSent||("cpu"===t.qualityLimitationReason&&s.push({statsSample:o,type:exports.IssueType.CPU,reason:exports.IssueReason.EncoderCPUThrottling,ssrc:t.ssrc}),"bandwidth"===t.qualityLimitationReason&&s.push({statsSample:o,type:exports.IssueType.Network,reason:exports.IssueReason.OutboundNetworkThroughput,ssrc:t.ssrc}))})),s):s}}class L extends y{UNKNOWN_DECODER="unknown";#d={};performDetection(t){return this.processData(t)}performPrevStatsCleanup(t){const{connectionId:e,cleanupCallback:s}=t;super.performPrevStatsCleanup({...t,cleanupCallback:()=>{delete this.#d[e],"function"==typeof s&&s()}})}processData(t){const e=[],{id:s}=t.connection,r=this.getLastProcessedStats(s)?.video.inbound;return t.video.inbound.forEach((t=>{const{decoderImplementation:o,ssrc:n}=t,i=r?.find((t=>t.ssrc===n));if(i)if(o===this.UNKNOWN_DECODER){if(!this.hadLastDecoderWithIssue(s,n)){this.setLastDecoderWithIssue(s,n,this.UNKNOWN_DECODER);const r={mimeType:t.mimeType,decoderImplementation:o};e.push({ssrc:n,statsSample:r,type:exports.IssueType.Stream,reason:exports.IssueReason.UnknownVideoDecoderIssue,trackIdentifier:t.track.trackIdentifier})}}else this.setLastDecoderWithIssue(s,n,void 0)})),e}setLastDecoderWithIssue(t,e,s){const r=this.#d[t]??{};void 0===s?delete r[e]:r[e]=s,this.#d[t]=r}hadLastDecoderWithIssue(t,e){const s=this.#d[t];return(s&&s[e])===this.UNKNOWN_DECODER}}const D=t=>t.reduce(((t,e)=>t+e),0)/t.length,R=(t,e,s=30)=>{const r=[];for(let s=1;s<e.length-1;s+=1){const o=e[s]?.video?.inbound.find((e=>e.ssrc===t));if(!o)continue;const n=e[s-1]?.video?.inbound?.find((e=>e.ssrc===t));if(!o||!n)continue;const i=o.timestamp-n.timestamp,a=o.framesDecoded-n.framesDecoded;if(a>0){const t=i/a;r.push(t)}}if(r.length<=1)return!1;return(t=>{const e=((t,e)=>e.reduce(((e,s)=>e+(s-t)**2),0)/e.length)(D(t),t);return Math.sqrt(e)})(r)>s},C=(t,e)=>{for(let s=1;s<e.length;s+=1){const r=e[s].video.inbound.find((e=>e.ssrc===t));if(!r)continue;const o=e[s-1].video.inbound.find((e=>e.ssrc===t)),n=r.frameWidth!==o?.frameWidth,i=r.frameHeight!==o?.frameHeight;if(n||i)return!0}return!1};class M extends y{#h;#p;#l;constructor(t={}){super(),this.#h=t.avgFreezeDurationThresholdMs??1e3,this.#p=t.frozenDurationThresholdPct??30,this.#l=t.minMosQuality??exports.MosQuality.BAD}performDetection(t){const e=t.networkScores.inbound;return void 0!==e&&e<=this.#l?[]:this.processData(t)}processData(t){const e=[],s=this.getAllLastProcessedStats(t.connection.id);if(0===s.length)return[];const r=t.video.inbound.map((e=>{const r=s[s.length-1].video.inbound.find((t=>t.ssrc===e.ssrc));if(!r)return;if(C(e.ssrc,[s[s.length-1],t]))return;if(R(e.ssrc,s))return;const o=e.freezeCount-(r.freezeCount??0),n=1e3*(e.totalFreezesDuration-(r.totalFreezesDuration??0)),i=o>0?n/o:0,a=n/(e.timestamp-r.timestamp)*100;return a>this.#p||i>this.#h?{ssrc:e.ssrc,avgFreezeDurationMs:i,frozenDurationPct:a}:void 0})).filter((t=>void 0!==t));return r.length>0&&(e.push({type:exports.IssueType.Stream,reason:exports.IssueReason.FrozenVideoTrack,statsSample:{ssrcs:r.map((t=>t.ssrc))}}),this.deleteLastProcessedStats(t.connection.id)),e}}class x extends y{#m;#f;#l;constructor(t={}){super(t),this.#m=t.volatilityThreshold??8,this.#f=t.affectedStreamsPercentThreshold??30,this.#l=t.minMosQuality??exports.MosQuality.BAD}performDetection(t){return[...this.getAllLastProcessedStats(t.connection.id),t].find((t=>void 0!==t.networkScores.inbound&&t.networkScores.inbound<=this.#l))?[]:this.processData(t)}processData(t){const e=[],s=[...this.getAllLastProcessedStats(t.connection.id),t],r=t.video.inbound.map((t=>{if(s.length<5)return;if(C(t.ssrc,s))return;const e=[];for(let r=0;r<s.length-1;r+=1){const o=s[r].video.inbound.find((e=>e.ssrc===t.ssrc));void 0!==o?.framesPerSecond&&e.push(o.framesPerSecond)}if(e.length<5)return;if(R(t.ssrc,s))return;const r=(t=>{if(0===t.length)throw new Error("Cannot calculate volatility for empty array");const e=D(t);return t.reduce(((t,s)=>t+Math.abs(s-e)),0)/t.length*100/e})(e);return r>this.#m?{ssrc:t.ssrc,allFps:e,volatility:r}:void 0})).filter((t=>Boolean(t)));if(0===r.length)return e;const o=r.length/(t.video.inbound.length/100);return o>this.#f&&(e.push({type:exports.IssueType.CPU,reason:exports.IssueReason.DecoderCPUThrottling,statsSample:{affectedStreamsPercent:o,throtthedStreams:r}}),this.deleteLastProcessedStats(t.connection.id)),e}}class E extends y{#g=new Map;#S;#v;constructor(t={}){super(),this.#S=t.timeoutMs??15e3,this.#v=t.steps??3}performDetection(t){return this.processData(t)}processData(t){const e=[],s=[...this.getAllLastProcessedStats(t.connection.id),t];if(s.length<this.#v)return e;const r=s.slice(-this.#v),o=r.map((t=>t.video.inbound)),n=r.map((t=>t.audio.inbound));e.push(...this.detectMissingData(n,exports.IssueType.Stream,exports.IssueReason.MissingAudioStreamData)),e.push(...this.detectMissingData(o,exports.IssueType.Stream,exports.IssueReason.MissingVideoStreamData));return new Set(this.#g.keys()).forEach((t=>{const e=this.#g.get(t);e&&Date.now()-e>this.#S&&this.removeMarkedIssue(t)})),e}detectMissingData(t,e,s){const r=[],o=t.pop(),n=E.mapStatsByTrackId(t);return o.forEach((t=>{const o=t.track.trackIdentifier,i=n.get(o);if(!Array.isArray(i)||0===i.length)return;if(t.track.detached||t.track.ended)return;if(!E.isAllBytesReceivedDidntChange(t.bytesReceived,i))return void this.removeMarkedIssue(o);if(!this.markIssue(o))return;const a={bytesReceived:t.bytesReceived};r.push({type:e,reason:s,statsSample:a,trackIdentifier:o})})),r}static mapStatsByTrackId(t){const e=new Map;return t.forEach((t=>{t.forEach((t=>{const s=e.get(t.track.trackIdentifier)||[];s.push(t),e.set(t.track.trackIdentifier,s)}))})),e}static isAllBytesReceivedDidntChange(t,e){for(let s=0;s<e.length;s+=1){if(e[s].bytesReceived!==t)return!1}return!0}markIssue(t){const e=Date.now(),s=this.#g.get(t);return(!s||e-s>this.#S)&&(this.#g.set(t,e),!0)}removeMarkedIssue(t){this.#g.delete(t)}}const N=t=>"closed"===t.iceConnectionState||"closed"===t.connectionState,_=(t,e,s)=>8*((t,e,s)=>{if(!e)return 0;const r=t[s],o=e[s];if(null==r||null==o)return 0;const n=Math.floor(t.timestamp)-Math.floor(e.timestamp);return 0===n?0:(Number(r)-Number(o))/n*1e3})(t,e,s);class A{connections=[];statsParser;constructor(t){this.statsParser=t.statsParser}listConnections(){return[...this.connections]}addPeerConnection(t){this.connections.push({id:t.id??String(Date.now()+Math.random().toString(32)),pc:t.pc})}removePeerConnection(t){const e=this.connections.findIndex((({pc:e})=>e===t.pc));e>=0&&this.removeConnectionsByIndexes([e])}async parse(){const t=[],e=this.connections.map((async(e,s)=>{if(!N(e.pc))return this.statsParser.parse(e);t.unshift(s)}));t.length&&this.removeConnectionsByIndexes(t);return(await Promise.all(e)).filter((t=>void 0!==t))}removeConnectionsByIndexes(t){t.forEach((t=>{this.connections.splice(t,1)}))}}class O{prevStats=new Map;allowedReportTypes=new Set(["candidate-pair","inbound-rtp","outbound-rtp","remote-outbound-rtp","remote-inbound-rtp","track","transport"]);ignoreSSRCList;logger;constructor(t){this.ignoreSSRCList=t.ignoreSSRCList??[],this.logger=t.logger}get previouslyParsedStatsConnectionsIds(){return[...this.prevStats.keys()]}async parse(t){if(!N(t.pc))return this.getConnectionStats(t);this.logger.debug("Skip stats parsing. Connection is closed.",{connection:t})}async getConnectionStats(t){const{pc:e,id:s}=t;try{const r=Date.now(),o=e.getReceivers().filter((t=>t.track?.enabled)),n=e.getSenders().filter((t=>t.track?.enabled)),i=await Promise.all(o.map((t=>t.getStats()))),a=await Promise.all(n.map((t=>t.getStats())));return{id:s,stats:this.mapReportsStats([...i,...a],t),timeTaken:Date.now()-r}}catch(t){return void this.logger.error("Failed to get stats for PC",{id:s,pc:e,error:t})}}mapReportsStats(t,e){const s={audio:{inbound:[],outbound:[]},video:{inbound:[],outbound:[]},connection:{},remote:{video:{inbound:[],outbound:[]},audio:{inbound:[],outbound:[]}}};t.forEach((t=>{t.forEach((e=>{this.allowedReportTypes.has(e.type)&&this.updateMappedStatsWithReportItemData(e,s,t)}))}));const{id:r}=e,o=this.prevStats.get(r);return o&&this.propagateStatsWithRateValues(s,o.stats),this.prevStats.set(r,{stats:s,ts:Date.now()}),v({taskId:r,delayMs:35e3,callback:()=>this.prevStats.delete(r)}),s}updateMappedStatsWithReportItemData(t,e,s){const r=t.type;if("candidate-pair"===r&&"succeeded"===t.state&&t.nominated)return void(e.connection=this.prepareConnectionStats(t,s));const o=this.getMediaType(t);if(!o)return;const n=t.ssrc;if(!n||!this.ignoreSSRCList.includes(n))if("outbound-rtp"!==r)if("inbound-rtp"!==r)"remote-outbound-rtp"!==r?"remote-inbound-rtp"===r&&(this.mapConnectionStatsIfNecessary(e,t,s),e.remote[o].inbound.push({...t})):e.remote[o].outbound.push({...t});else{const r=s.get(t.trackId)||s.get(t.mediaSourceId)||{};this.mapConnectionStatsIfNecessary(e,t,s);const n={...t,track:{...r}};e[o].inbound.push(n)}else{const r=s.get(t.trackId)||s.get(t.mediaSourceId)||{},n={...t,track:{...r}};e[o].outbound.push(n)}}getMediaType(t){const e=t.mediaType||t.kind;if(!["audio","video"].includes(e)){const{id:e}=t;if(!e)return;return String(e).includes("Video")?"video":String(e).includes("Audio")?"audio":void 0}return e}propagateStatsWithRateValues(t,e){t.audio.inbound.forEach((t=>{const s=e.audio.inbound.find((({id:e})=>e===t.id));t.bitrate=_(t,s,"bytesReceived"),t.packetRate=_(t,s,"packetsReceived")})),t.audio.outbound.forEach((t=>{const s=e.audio.outbound.find((({id:e})=>e===t.id));t.bitrate=_(t,s,"bytesSent"),t.packetRate=_(t,s,"packetsSent")})),t.video.inbound.forEach((t=>{const s=e.video.inbound.find((({id:e})=>e===t.id));t.bitrate=_(t,s,"bytesReceived"),t.packetRate=_(t,s,"packetsReceived")})),t.video.outbound.forEach((t=>{const s=e.video.outbound.find((({id:e})=>e===t.id));t.bitrate=_(t,s,"bytesSent"),t.packetRate=_(t,s,"packetsSent")}))}mapConnectionStatsIfNecessary(t,e,s){if(t.connection.id||!e.transportId)return;const r=s.get(e.transportId);if(r&&r.selectedCandidatePairId){const e=s.get(r.selectedCandidatePairId);t.connection=this.prepareConnectionStats(e,s)}}prepareConnectionStats(t,e){if(!t||!e)return{};const s={...t};if(s.remoteCandidateId){const t=e.get(s.remoteCandidateId);s.remote={...t}}if(s.localCandidateId){const t=e.get(s.localCandidateId);s.local={...t}}return s}}exports.AvailableOutgoingBitrateIssueDetector=w,exports.BaseIssueDetector=y,exports.CompositeRTCStatsParser=A,exports.FrozenVideoTrackDetector=M,exports.InboundNetworkIssueDetector=T,exports.MissingStreamDataDetector=E,exports.NetworkMediaSyncIssueDetector=b,exports.NetworkScoresCalculator=k,exports.OutboundNetworkIssueDetector=P,exports.PeriodicWebRTCStatsReporter=S,exports.QualityLimitationsIssueDetector=I,exports.RTCStatsParser=O,exports.UnknownVideoDecoderImplementationDetector=L,exports.VideoDecoderIssueDetector=x,exports.WebRTCIssueEmitter=g,exports.default=class{eventEmitter;#k=!1;detectors=[];networkScoresCalculator;statsReporter;compositeStatsParser;logger;autoAddPeerConnections;constructor(t){this.logger=t.logger??{debug:()=>{},info:()=>{},warn:()=>{},error:()=>{}},this.eventEmitter=t.issueEmitter??new g,t.onIssues&&this.eventEmitter.on(exports.EventType.Issue,t.onIssues),t.onNetworkScoresUpdated&&this.eventEmitter.on(exports.EventType.NetworkScoresUpdated,t.onNetworkScoresUpdated),this.detectors=t.detectors??[new I,new T,new P,new b,new w,new L,new M,new x,new E],this.networkScoresCalculator=t.networkScoresCalculator??new k,this.compositeStatsParser=t.compositeStatsParser??new A({statsParser:new O({ignoreSSRCList:t.ignoreSSRCList,logger:this.logger})}),this.statsReporter=t.statsReporter??new S({compositeStatsParser:this.compositeStatsParser,getStatsInterval:t.getStatsInterval??5e3}),window.wid=this,this.autoAddPeerConnections=t.autoAddPeerConnections??!0,this.autoAddPeerConnections&&this.wrapRTCPeerConnection(),this.statsReporter.on(S.STATS_REPORT_READY_EVENT,(t=>{const e=this.calculateNetworkScores(t.stats);this.detectIssues({data:t.stats},e)})),this.statsReporter.on(S.STATS_REPORTS_PARSED,(e=>{const s={timeTaken:e.timeTaken,ts:Date.now()};t.onStats&&t.onStats(e.reportItems),this.eventEmitter.emit(exports.EventType.StatsParsingFinished,s)}))}watchNewPeerConnections(){if(!this.autoAddPeerConnections)throw new Error("Auto add peer connections was disabled in the constructor.");this.#k?this.logger.warn("WebRTCIssueDetector is already started. Skip processing"):(this.logger.info("Start watching peer connections"),this.#k=!0,this.statsReporter.startReporting())}stopWatchingNewPeerConnections(){this.#k?(this.logger.info("Stop watching peer connections"),this.#k=!1,this.statsReporter.stopReporting()):this.logger.warn("WebRTCIssueDetector is already stopped. Skip processing")}handleNewPeerConnection(t,e){this.#k||!this.autoAddPeerConnections?(this.#k||!1!==this.autoAddPeerConnections||(this.logger.info("Starting stats reporting for new peer connection"),this.#k=!0,this.statsReporter.startReporting()),this.logger.debug("Handling new peer connection",t),this.compositeStatsParser.addPeerConnection({pc:t,id:e})):this.logger.debug("Skip handling new peer connection. Detector is not running",t)}emitIssues(t){this.eventEmitter.emit(exports.EventType.Issue,t)}detectIssues({data:t},e){const s=this.detectors.reduce(((s,r)=>[...s,...r.detect(t,e)]),[]);s.length>0&&this.emitIssues(s)}calculateNetworkScores(t){const e=this.networkScoresCalculator.calculate(t);return this.eventEmitter.emit(exports.EventType.NetworkScoresUpdated,e),e}wrapRTCPeerConnection(){if(!window.RTCPeerConnection)return void this.logger.warn("No RTCPeerConnection found in browser window. Skipping");const t=window.RTCPeerConnection,e=t=>this.handleNewPeerConnection(t);function s(s){const r=new t(s);return e(r),r}s.prototype=t.prototype,window.RTCPeerConnection=s}};
